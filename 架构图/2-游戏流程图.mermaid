graph TD
    %% 游戏启动流程
    START([游戏启动]) --> LAUNCHER_UI[显示启动器界面]
    LAUNCHER_UI --> PLAYER_SETUP[设置玩家数量和信息]
    PLAYER_SETUP --> CREATE_ENGINE[创建游戏引擎]
    CREATE_ENGINE --> INIT_GAME[初始化游戏状态]
    INIT_GAME --> SHOW_MAIN[显示主游戏窗口]

    %% 游戏主循环
    SHOW_MAIN --> GAME_LOOP{游戏主循环}
    
    %% 回合开始
    GAME_LOOP --> TURN_START[回合开始<br/>当前玩家准备]
    TURN_START --> ROLL_PHASE[投骰子阶段<br/>TurnPhase.ROLL_DICE]
    
    %% 投骰子
    ROLL_PHASE --> ROLL_DICE[玩家点击投骰子]
    ROLL_DICE --> DICE_RESULT[显示骰子结果<br/>1-6点]
    DICE_RESULT --> MOVE_PHASE[移动阶段<br/>TurnPhase.MOVE]
    
    %% 移动玩家
    MOVE_PHASE --> MOVE_PLAYER[玩家点击移动]
    MOVE_PLAYER --> UPDATE_POSITION[更新玩家位置]
    UPDATE_POSITION --> SQUARE_EVENT_PHASE[格子事件阶段<br/>TurnPhase.SQUARE_EVENT]
    
    %% 格子事件处理
    SQUARE_EVENT_PHASE --> CHECK_SQUARE{检查格子类型}
    
    %% 不同格子类型的处理
    CHECK_SQUARE -->|paycheck| PAYCHECK[收取工资和被动收入<br/>支付月支出]
    CHECK_SQUARE -->|opportunity| OPPORTUNITY[抽取投资卡片]
    CHECK_SQUARE -->|market| MARKET[进入市场模式]
    CHECK_SQUARE -->|doodad| DOODAD[扣除意外费用]
    CHECK_SQUARE -->|charity| CHARITY[根据孩子数获得奖励]
    CHECK_SQUARE -->|downsized| DOWNSIZED[设置裁员状态]
    CHECK_SQUARE -->|baby| BABY[增加孩子和支出]
    
    %% 机会卡片决策
    OPPORTUNITY --> CARD_DECISION_PHASE[卡片决策阶段<br/>TurnPhase.CARD_DECISION]
    CARD_DECISION_PHASE --> SHOW_CARD[显示卡片信息]
    SHOW_CARD --> CARD_CHOICE{玩家选择}
    CARD_CHOICE -->|buy| BUY_CARD[执行购买逻辑<br/>扣除费用，添加资产]
    CARD_CHOICE -->|pass| PASS_CARD[放弃卡片]
    
    %% 市场操作
    MARKET --> MARKET_PHASE[市场操作阶段<br/>TurnPhase.MARKET]
    MARKET_PHASE --> MARKET_CHOICE{市场操作}
    MARKET_CHOICE -->|trade| ASSET_TRADE[资产交易]
    MARKET_CHOICE -->|exit| EXIT_MARKET[退出市场]
    
    %% 回合结束
    PAYCHECK --> END_TURN_PHASE[结束回合阶段<br/>TurnPhase.END_TURN]
    DOODAD --> END_TURN_PHASE
    CHARITY --> END_TURN_PHASE
    DOWNSIZED --> END_TURN_PHASE
    BABY --> END_TURN_PHASE
    BUY_CARD --> END_TURN_PHASE
    PASS_CARD --> END_TURN_PHASE
    ASSET_TRADE --> END_TURN_PHASE
    EXIT_MARKET --> END_TURN_PHASE
    
    %% 检查游戏结束条件
    END_TURN_PHASE --> END_TURN_CLICK[玩家点击结束回合]
    END_TURN_CLICK --> CHECK_WIN{检查财务自由}
    CHECK_WIN -->|yes| GAME_END[游戏结束<br/>宣布获胜者]
    CHECK_WIN -->|no| NEXT_PLAYER[切换到下一玩家]
    
    %% 循环继续
    NEXT_PLAYER --> GAME_LOOP
    
    %% 游戏结束
    GAME_END --> SHOW_RESULT[显示游戏结果]
    SHOW_RESULT --> GAME_OVER([游戏结束])

    %% 样式定义
    classDef startNode fill:#e3f2fd
    classDef phaseNode fill:#f3e5f5
    classDef actionNode fill:#e8f5e8
    classDef decisionNode fill:#fff3e0
    classDef endNode fill:#ffebee

    class START,GAME_OVER startNode
    class ROLL_PHASE,MOVE_PHASE,SQUARE_EVENT_PHASE,CARD_DECISION_PHASE,MARKET_PHASE,END_TURN_PHASE phaseNode
    class ROLL_DICE,MOVE_PLAYER,PAYCHECK,OPPORTUNITY,MARKET,DOODAD,CHARITY,DOWNSIZED,BABY,BUY_CARD,PASS_CARD,ASSET_TRADE,EXIT_MARKET actionNode
    class CHECK_SQUARE,CARD_CHOICE,MARKET_CHOICE,CHECK_WIN decisionNode
    class GAME_END,SHOW_RESULT endNode 